package trivyhelper

import (
	"context"
	"os"

	dlog "github.com/aquasecurity/go-dep-parser/pkg/log"
	"github.com/aquasecurity/trivy/pkg/commands/artifact"
	flog "github.com/aquasecurity/trivy/pkg/fanal/log"
	"github.com/aquasecurity/trivy/pkg/flag"
	trivyLog "github.com/aquasecurity/trivy/pkg/log"
	"github.com/aquasecurity/trivy/pkg/types"
	"github.com/arman1371/vulnerability-scanner-api/log"
	"github.com/spf13/viper"
)

var (
	version     string                = "dev"
	configPath  string                = "config/trivy-default.yaml"
	globalFlags *flag.GlobalFlagGroup = flag.NewGlobalFlagGroup()
	imageFlags  *flag.Flags
)

func InitTrivyHelper() error {
	viper.SetConfigFile(configPath)
	viper.SetConfigType("yaml")
	if err := viper.ReadInConfig(); err != nil {
		return err
	}

	// Initialize trivy logger
	trivyLog.Logger = log.Logger
	dlog.SetLogger(log.Logger)
	flog.SetLogger(log.Logger)

	imageFlags = createImageFlags()
	return nil
}

func ScanImage(ctx context.Context, image string) (*types.Report, error) {

	options, err := imageFlags.ToOptions(version, []string{image}, globalFlags, os.Stdout)
	if err != nil {
		return nil, err
	}

	ctx, cancel := context.WithTimeout(ctx, options.Timeout)
	defer cancel()

	r, err := artifact.NewRunner(ctx, options)
	if err != nil {
		return nil, err
	}
	defer r.Close(ctx)

	var report types.Report
	if report, err = r.ScanImage(ctx, options); err != nil {
		return nil, err
	}

	report, err = r.Filter(ctx, options, report)
	if err != nil {
		return nil, err
	}

	return &report, nil
}

func createImageFlags() *flag.Flags {
	reportFlagGroup := flag.NewReportFlagGroup()
	reportFlagGroup.ReportFormat = nil

	return &flag.Flags{
		CacheFlagGroup:         flag.NewCacheFlagGroup(),
		DBFlagGroup:            flag.NewDBFlagGroup(),
		ImageFlagGroup:         flag.NewImageFlagGroup(), // container image specific
		LicenseFlagGroup:       flag.NewLicenseFlagGroup(),
		MisconfFlagGroup:       flag.NewMisconfFlagGroup(),
		RemoteFlagGroup:        flag.NewClientFlags(), // for client/server mode
		RegoFlagGroup:          flag.NewRegoFlagGroup(),
		ReportFlagGroup:        reportFlagGroup,
		ScanFlagGroup:          flag.NewScanFlagGroup(),
		SecretFlagGroup:        flag.NewSecretFlagGroup(),
		VulnerabilityFlagGroup: flag.NewVulnerabilityFlagGroup(),
	}
}
